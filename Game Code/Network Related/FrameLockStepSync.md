# 帧同步

## 概念澄清
讨论帧同步时，往往不同的人对于一些细节有不同的见解而争执不下，这往往是因为“帧同步”这个名词有歧义，而且并不能概括这套方案的特征。知乎有个帖子对此进行了细致的讨论（[这里](https://zhuanlan.zhihu.com/p/32843758)），结论如图：

![](/assets/frameSyncConcept.jpg)

本文所说的帧同步，其实是上图中“frame lockstep sync”，状态同步是“status sync”。

## 王者荣耀团队分享
### （一）帧同步和状态同步的对比
#### 状态同步的方案特点
- 优点
  - 安全（因为有关键逻辑都在服务器上）
  - 网络要求低
  - 断线重回快（因为有状态快照）
  - 客户端性能优化（视野之外逻辑可以不要的，反正服务器在算全局的）。所以千人大战这种一定是C/S架构的。
- 缺点
  - 开发慢（因为要联调）
  - 录像回放实现较难
  - 打击感难调
  - 耗流量

#### 帧同步的方案特点
- 优点和缺点恰好是状态同步方案的互补。其中外挂是一个重点，而断线重回时间长是一个难点，不能胜任千人大战是无法突破的瓶颈（因为所有东西都要放在客户端算）。

#### 王者荣耀团队是如何取舍的
当时主要是开发效率的角度考虑，还有打击感。省流量和方便做回放是附带的好处。

###（二）帧同步实现要点
在实践帧同步的时候，有以下几个方面需要把控：
- 相同初始状态
- 一致的输入
- 一致的代码执行流程
- 一致的数学库（随机数、去浮点改用整数）
- 第三方库改造
- 开发人员写逻辑时要去除“我”这个玩家角色的概念
- 开发人员要能在发生不同步时定位问题


###（三）帧同步会遇到的问题
#### 延迟和卡顿
延迟和卡顿是一对 trade-off，取决于buffer的大小。

首先说卡顿。这里不是指渲染性能或逻辑处理上的瓶颈（事实上画面卡顿的原因很多，后面会补充），而是特指严格按帧进行表现时，会由于网络延迟时大时小，造成角色移动不平滑等现象。

为了解决网络延迟抖动的问题，帧同步方案设计了一个buffer，收到网络的逻辑帧后，会先在本地缓存若干帧，按照固定延迟去播放，这样逻辑执行就比较平稳看上去不会一顿一顿的。但很明显这样操作和反馈都比较滞后。

这就是延迟问题。



#### 断线重回

#### 外挂

#### 优化

















